

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.jpg">
  <link rel="icon" href="/img/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Keyun Luo">
  <meta name="keywords" content="">
  
    <meta name="description" content="TA-Lib是一个技术分析库，涵盖了150多种股票、期货交易软件中常用的技术分析指标，如MACD、RSI、KDJ、动量指标、布林带等等，而pandas-ta则是一个基于pandas和ta-lib的高级技术分析工具，具有​​130多个指标和实用功能以及60多个TA-Lib中包含的蜡烛模式。本章节记录如何利用pandas-ta快速提取技术面特征。  安装安装pandas-ta本身非常简单，直接pip">
<meta property="og:type" content="article">
<meta property="og:title" content="利用pandas_ta自动提取技术面特征">
<meta property="og:url" content="https://keyunluo.github.io/2022/07/09/%E5%88%A9%E7%94%A8pandas_ta%E8%87%AA%E5%8A%A8%E6%8F%90%E5%8F%96%E6%8A%80%E6%9C%AF%E9%9D%A2%E7%89%B9%E5%BE%81/index.html">
<meta property="og:site_name" content="流光">
<meta property="og:description" content="TA-Lib是一个技术分析库，涵盖了150多种股票、期货交易软件中常用的技术分析指标，如MACD、RSI、KDJ、动量指标、布林带等等，而pandas-ta则是一个基于pandas和ta-lib的高级技术分析工具，具有​​130多个指标和实用功能以及60多个TA-Lib中包含的蜡烛模式。本章节记录如何利用pandas-ta快速提取技术面特征。  安装安装pandas-ta本身非常简单，直接pip">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://keyunluo.github.io/img/qrcode.jpg">
<meta property="article:published_time" content="2022-07-09T10:00:00.000Z">
<meta property="article:modified_time" content="2022-07-09T11:56:23.600Z">
<meta property="article:author" content="Keyun Luo">
<meta property="article:tag" content="talib">
<meta property="article:tag" content="pandas_ta">
<meta property="article:tag" content="技术分析">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://keyunluo.github.io/img/qrcode.jpg">
  
  
  <title>利用pandas_ta自动提取技术面特征 - 流光</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.6.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"keyunluo.github.io","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"e2bacb4062644434b87a03658392592e","google":null,"gtag":"G-7YSYVRNN9T","tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"NQndU9io17iF8X4gY3Ifs1RO-gzGzoHsz","app_key":"ODqlMdJWwrMxHFHzfz3pMvBS","server_url":"https://nqndu9io.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
  <header style="height: 30vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="利用pandas_ta自动提取技术面特征">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-07-09 18:00" pubdate>
        2022年7月9日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      23k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      189 分钟
    </span>
  

  
  
    
      <!-- LeanCloud 统计文章PV -->
      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">利用pandas_ta自动提取技术面特征</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2022年7月9日 晚上
                
              </p>
            
            <div class="markdown-body">
              <blockquote>
<p>TA-Lib是一个技术分析库，涵盖了150多种股票、期货交易软件中常用的技术分析指标，如MACD、RSI、KDJ、动量指标、布林带等等，而<code>pandas-ta</code>则是一个基于pandas和ta-lib的高级技术分析工具，具有​​130多个指标和实用功能以及60多个TA-Lib中包含的蜡烛模式。本章节记录如何利用<code>pandas-ta</code>快速提取技术面特征。</p>
</blockquote>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装<code>pandas-ta</code>本身非常简单，直接pip一下就可以，如果想用ta-lib的一些特性，则还需要安装<code>ta-lib</code>本身</p>
<ul>
<li>Anaconda：使用Anaconda集成环境，可直接<code>conda install -c conda-forge ta-lib</code></li>
<li>Windows: 直接在<a target="_blank" rel="noopener" href="https://www.lfd.uci.edu/~gohlke/pythonlibs/#ta-lib">https://www.lfd.uci.edu/~gohlke/pythonlibs/#ta-lib</a> 中下载离线包安装即可</li>
<li>Linux: 需要编译安装C++原始环境库(<a target="_blank" rel="noopener" href="http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz">http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz</a>) ，然后pip安装<code>pip install TA-Lib</code></li>
</ul>
<p>pandas-ta提供的主要函数有：</p>
<ul>
<li>蜡烛图形态：Candles ，基于K线图的形态识别，如三只乌鸦等</li>
<li>周期特征：Cycles，如正弦波拟合等</li>
<li>动量特征：Momentum，如KDJ、RSI等</li>
<li>覆盖特征：Overlap，主要包含各种移动平均线系列，如EMA指数平滑</li>
<li>回报特征：Performance ，如百分比回报、log回报等</li>
<li>统计特征：Statistics，如熵、中位数、分位数、标准差等</li>
<li>趋势特征：Trend， 如阿隆指数等</li>
<li>波动率特征：Volatility，如布林带等 </li>
<li>成交量特征：Volume，如资金流指数等</li>
<li>其他特征：如神奇九转(td_seq)等</li>
</ul>
<h2 id="准备K线数据"><a href="#准备K线数据" class="headerlink" title="准备K线数据"></a>准备K线数据</h2><p>这里主要提取1min和1d两种粒度数据中的特征，日内1分钟数据未除权，日间1天数据使用后复权，保持序列的连贯性。</p>
<h3 id="读取日内K线数据-未复权"><a href="#读取日内K线数据-未复权" class="headerlink" title="读取日内K线数据(未复权)"></a>读取日内K线数据(未复权)</h3><p>这里以聚宽数据为例，读取指定时间区间中1min数据，并生成对应的日内收益标签，详细功能见代码中的注释。</p>
<p>主要的收益计算为日内指标，分为有两类：</p>
<ul>
<li>日内剩余时间段里的平均收益百分比</li>
<li>日内随后5min、10min的平均收益</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 日内：聚宽</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_jqdata_kline</span>(<span class="hljs-params">code=<span class="hljs-string">&#x27;510050.SH&#x27;</span>, start_date=<span class="hljs-string">&#x27;2021-11-01&#x27;</span>, end_date=<span class="hljs-string">&#x27;2022-01-01&#x27;</span></span>):</span><br>    <span class="hljs-comment"># 代码转换</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> code.endswith((<span class="hljs-string">&#x27;.XSHG&#x27;</span>, <span class="hljs-string">&#x27;.XSHE&#x27;</span>)):<br>        ticker, exchange  = code.split(<span class="hljs-string">&#x27;.&#x27;</span>)<br>        code = ticker + <span class="hljs-string">&#x27;.&#x27;</span> + &#123;<span class="hljs-string">&#x27;SZ&#x27;</span>: <span class="hljs-string">&#x27;XSHE&#x27;</span>, <span class="hljs-string">&#x27;BJ&#x27;</span>: <span class="hljs-string">&#x27;XSHE&#x27;</span>, <span class="hljs-string">&#x27;SH&#x27;</span>: <span class="hljs-string">&#x27;XSHG&#x27;</span>&#125;.get(exchange.upper())<br>    <span class="hljs-comment"># 提取stock_kline中的1min数据</span><br>    query = <span class="hljs-string">&quot;select * from jqdata.stock_kline where code=&#x27;&#123;&#125;&#x27; and volume !=0.0  and trade_day &gt;=&#x27;&#123;&#125;&#x27; and trade_day &lt;&#x27;&#123;&#125;&#x27; and toDayOfWeek(trade_day) &lt; 6&quot;</span>.<span class="hljs-built_in">format</span>(code, start_date, end_date)<br>    data = client.execute(query)<br><br>    <span class="hljs-comment"># 提取stock_dayline中的1d数据,主要是复权因子</span><br>    day_query = <span class="hljs-string">&quot;select trade_day, pre_close, factor from jqdata.stock_dayline where code=&#x27;&#123;&#125;&#x27; and volume !=0.0  and trade_day &gt;=&#x27;&#123;&#125;&#x27; and trade_day &lt;&#x27;&#123;&#125;&#x27; and toDayOfWeek(trade_day) &lt; 6&quot;</span>.<span class="hljs-built_in">format</span>(code, start_date, end_date)<br>    day_data = client.execute(day_query)<br>    <span class="hljs-comment"># 获取复权后的昨收数据</span><br>    pre_close = &#123;i[<span class="hljs-number">0</span>]: np.<span class="hljs-built_in">round</span>(i[<span class="hljs-number">1</span>] / i[<span class="hljs-number">2</span>] , <span class="hljs-number">3</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span>  day_data&#125;<br><br>    df = pd.DataFrame(data, columns=[<span class="hljs-string">&#x27;code&#x27;</span>, <span class="hljs-string">&#x27;dtype&#x27;</span>, <span class="hljs-string">&#x27;trade_day&#x27;</span>, <span class="hljs-string">&#x27;trade_time&#x27;</span>, <span class="hljs-string">&#x27;open&#x27;</span>, <span class="hljs-string">&#x27;close&#x27;</span>, <span class="hljs-string">&#x27;low&#x27;</span>, <span class="hljs-string">&#x27;high&#x27;</span>, <span class="hljs-string">&#x27;volume&#x27;</span>, <span class="hljs-string">&#x27;money&#x27;</span>, <span class="hljs-string">&#x27;avg&#x27;</span>])<br>    df = df.sort_values(by=<span class="hljs-string">&#x27;trade_time&#x27;</span>).drop_duplicates(subset=[<span class="hljs-string">&#x27;trade_time&#x27;</span>], keep=<span class="hljs-string">&#x27;first&#x27;</span>).reset_index(drop=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 补充昨收数据</span><br>    df[<span class="hljs-string">&#x27;pre_close&#x27;</span>] = df[<span class="hljs-string">&#x27;trade_day&#x27;</span>].apply(<span class="hljs-keyword">lambda</span> x: pre_close.get(x, <span class="hljs-number">0</span>))<br>    df[<span class="hljs-string">&#x27;trade_day&#x27;</span>] = df[<span class="hljs-string">&#x27;trade_day&#x27;</span>].astype(<span class="hljs-built_in">str</span>)<br><br>    <span class="hljs-comment"># 当天收盘相对于昨收的百分比</span><br>    df[<span class="hljs-string">&#x27;daily_percent&#x27;</span>] = (df[<span class="hljs-string">&#x27;close&#x27;</span>] - df[<span class="hljs-string">&#x27;pre_close&#x27;</span>]) / df[<span class="hljs-string">&#x27;pre_close&#x27;</span>]<br>    df[<span class="hljs-string">&#x27;minutes_of_day&#x27;</span>] = df.trade_time.dt.hour * <span class="hljs-number">60</span> + df.trade_time.dt.minute<br><br>    <span class="hljs-comment"># 过滤尾盘集合竞价数据    </span><br>    df = df[~df.minutes_of_day.isin([<span class="hljs-number">898</span>, <span class="hljs-number">899</span>])]<br><br>    <span class="hljs-comment"># 此刻买进，日内剩余时间段内的收益25%分位数</span><br>    df[<span class="hljs-string">&#x27;label_d0_25&#x27;</span>] = ((df.groupby([<span class="hljs-string">&#x27;trade_day&#x27;</span>])[<span class="hljs-string">&#x27;avg&#x27;</span>].transform(<span class="hljs-keyword">lambda</span> row: row[::-<span class="hljs-number">1</span>].shift(<span class="hljs-number">1</span>).expanding(min_periods=<span class="hljs-number">1</span>).quantile(<span class="hljs-number">0.25</span>)[::-<span class="hljs-number">1</span>]) - df[<span class="hljs-string">&#x27;avg&#x27;</span>]) * <span class="hljs-number">100</span>).div(df[<span class="hljs-string">&#x27;avg&#x27;</span>])<br>    <span class="hljs-comment"># 此刻买进，日内剩余时间段内的收益50%分位数</span><br>    df[<span class="hljs-string">&#x27;label_d0_50&#x27;</span>] = ((df.groupby([<span class="hljs-string">&#x27;trade_day&#x27;</span>])[<span class="hljs-string">&#x27;avg&#x27;</span>].transform(<span class="hljs-keyword">lambda</span> row: row[::-<span class="hljs-number">1</span>].shift(<span class="hljs-number">1</span>).expanding(min_periods=<span class="hljs-number">1</span>).quantile(<span class="hljs-number">0.5</span>)[::-<span class="hljs-number">1</span>]) - df[<span class="hljs-string">&#x27;avg&#x27;</span>]) * <span class="hljs-number">100</span>).div(df[<span class="hljs-string">&#x27;avg&#x27;</span>])<br>    <span class="hljs-comment"># 此刻买进，日内剩余时间段内的收益75%分位数</span><br>    df[<span class="hljs-string">&#x27;label_d0_75&#x27;</span>] = ((df.groupby([<span class="hljs-string">&#x27;trade_day&#x27;</span>])[<span class="hljs-string">&#x27;avg&#x27;</span>].transform(<span class="hljs-keyword">lambda</span> row: row[::-<span class="hljs-number">1</span>].shift(<span class="hljs-number">1</span>).expanding(min_periods=<span class="hljs-number">1</span>).quantile(<span class="hljs-number">0.75</span>)[::-<span class="hljs-number">1</span>]) - df[<span class="hljs-string">&#x27;avg&#x27;</span>]) * <span class="hljs-number">100</span>).div(df[<span class="hljs-string">&#x27;avg&#x27;</span>])<br><br>    <span class="hljs-comment"># 此刻买进，日内5分钟时间段内的收益50%分位具体值</span><br>    df[<span class="hljs-string">&#x27;label_rolling_5_50_bps&#x27;</span>] = (df.groupby([<span class="hljs-string">&#x27;trade_day&#x27;</span>])[<span class="hljs-string">&#x27;avg&#x27;</span>].transform(<span class="hljs-keyword">lambda</span> row: row[::-<span class="hljs-number">1</span>].shift(<span class="hljs-number">1</span>).rolling(<span class="hljs-number">5</span>, min_periods=<span class="hljs-number">1</span>).quantile(<span class="hljs-number">0.5</span>)[::-<span class="hljs-number">1</span>]) - df[<span class="hljs-string">&#x27;avg&#x27;</span>]) * <span class="hljs-number">100</span><br>    <span class="hljs-comment"># 此刻买进，日内5分钟时间段内的收益50%分位数</span><br>    df[<span class="hljs-string">&#x27;label_rolling_5_50&#x27;</span>] = df[<span class="hljs-string">&#x27;label_rolling_5_50_bps&#x27;</span>].div(df[<span class="hljs-string">&#x27;avg&#x27;</span>])<br>    <span class="hljs-comment"># 此刻买进，日内10分钟时间段内的收益50%分位具体值</span><br>    df[<span class="hljs-string">&#x27;label_rolling_10_50_bps&#x27;</span>] = df.groupby([<span class="hljs-string">&#x27;trade_day&#x27;</span>])[<span class="hljs-string">&#x27;avg&#x27;</span>].transform(<span class="hljs-keyword">lambda</span> row: row[::-<span class="hljs-number">1</span>].shift(<span class="hljs-number">1</span>).rolling(<span class="hljs-number">10</span>, min_periods=<span class="hljs-number">1</span>).quantile(<span class="hljs-number">0.5</span>)[::-<span class="hljs-number">1</span>]) - df[<span class="hljs-string">&#x27;avg&#x27;</span>]<br>    <span class="hljs-comment"># 此刻买进，日内10分钟时间段内的收益50%分位数</span><br>    df[<span class="hljs-string">&#x27;label_rolling_10_50&#x27;</span>] = df[<span class="hljs-string">&#x27;label_rolling_10_50_bps&#x27;</span>].div(df[<span class="hljs-string">&#x27;avg&#x27;</span>])<br><br>    <span class="hljs-keyword">return</span> df.reset_index(drop=<span class="hljs-literal">True</span>)<br><br></code></pre></td></tr></table></figure>

<h3 id="读取日间K线数据-后复权"><a href="#读取日间K线数据-后复权" class="headerlink" title="读取日间K线数据(后复权)"></a>读取日间K线数据(后复权)</h3><p>日线有两个，一个是聚宽数据，主要针对国内市场，还有一个是华盛通数据，针对香港和美国市场，都从clickhouse数据库中读取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 日线: 华盛通</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_hstong_dayline</span>(<span class="hljs-params">market=<span class="hljs-string">&#x27;cn&#x27;</span>, code=<span class="hljs-string">&#x27;300369.SZ&#x27;</span>, start_date=<span class="hljs-string">&#x27;2018-11-01&#x27;</span>, end_date=<span class="hljs-string">&#x27;2022-01-01&#x27;</span></span>):</span><br>    query = <span class="hljs-string">&quot;select code, data_date, price_open, price_close, price_low, price_high, price_last, volume, deal  from hstong.dayline_hfq_&#123;&#125; where code=&#x27;&#123;&#125;&#x27; and volume !=0.0  and data_date &gt;=&#x27;&#123;&#125;&#x27; and data_date &lt;=&#x27;&#123;&#125;&#x27; and toDayOfWeek(data_date) &lt; 6&quot;</span>.<span class="hljs-built_in">format</span>(market, code, start_date, end_date)<br>    data = client.execute(query)<br>    df = pd.DataFrame(data, columns=[<span class="hljs-string">&#x27;code&#x27;</span>, <span class="hljs-string">&#x27;trade_day&#x27;</span>, <span class="hljs-string">&#x27;open&#x27;</span>, <span class="hljs-string">&#x27;close&#x27;</span>, <span class="hljs-string">&#x27;low&#x27;</span>, <span class="hljs-string">&#x27;high&#x27;</span>, <span class="hljs-string">&#x27;pre_close&#x27;</span>, <span class="hljs-string">&#x27;volume&#x27;</span>, <span class="hljs-string">&#x27;money&#x27;</span>])<br>    df = df.sort_values(by=<span class="hljs-string">&#x27;trade_day&#x27;</span>).drop_duplicates(subset=[<span class="hljs-string">&#x27;trade_day&#x27;</span>], keep=<span class="hljs-string">&#x27;first&#x27;</span>).reset_index(drop=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> df<br><br><span class="hljs-comment"># 日线：聚宽</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_jqdata_dayline</span>(<span class="hljs-params">code=<span class="hljs-string">&#x27;510050.SH&#x27;</span>, start_date=<span class="hljs-string">&#x27;2018-11-01&#x27;</span>, end_date=<span class="hljs-string">&#x27;2022-01-01&#x27;</span></span>):</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> code.endswith((<span class="hljs-string">&#x27;.XSHG&#x27;</span>, <span class="hljs-string">&#x27;.XSHE&#x27;</span>)):<br>        ticker, exchange  = code.split(<span class="hljs-string">&#x27;.&#x27;</span>)<br>        code = ticker + <span class="hljs-string">&#x27;.&#x27;</span> + &#123;<span class="hljs-string">&#x27;SZ&#x27;</span>: <span class="hljs-string">&#x27;XSHE&#x27;</span>, <span class="hljs-string">&#x27;BJ&#x27;</span>: <span class="hljs-string">&#x27;XSHE&#x27;</span>, <span class="hljs-string">&#x27;SH&#x27;</span>: <span class="hljs-string">&#x27;XSHG&#x27;</span>&#125;.get(exchange.upper())<br>    query = <span class="hljs-string">&quot;select code, trade_day, open, close, low, high, pre_close, volume, money, factor  from jqdata.stock_dayline where code=&#x27;&#123;&#125;&#x27; and volume !=0.0  and trade_day &gt;=&#x27;&#123;&#125;&#x27; and trade_day &lt;&#x27;&#123;&#125;&#x27; and toDayOfWeek(trade_day) &lt; 6&quot;</span>.<span class="hljs-built_in">format</span>(code, start_date, end_date)<br>    data = client.execute(query)<br>    df = pd.DataFrame(data, columns=[<span class="hljs-string">&#x27;code&#x27;</span>, <span class="hljs-string">&#x27;trade_day&#x27;</span>, <span class="hljs-string">&#x27;open&#x27;</span>, <span class="hljs-string">&#x27;close&#x27;</span>, <span class="hljs-string">&#x27;low&#x27;</span>, <span class="hljs-string">&#x27;high&#x27;</span>, <span class="hljs-string">&#x27;pre_close&#x27;</span>, <span class="hljs-string">&#x27;volume&#x27;</span>, <span class="hljs-string">&#x27;money&#x27;</span>, <span class="hljs-string">&#x27;factor&#x27;</span>])<br>    df = df.sort_values(by=<span class="hljs-string">&#x27;trade_day&#x27;</span>).drop_duplicates(subset=[<span class="hljs-string">&#x27;trade_day&#x27;</span>], keep=<span class="hljs-string">&#x27;first&#x27;</span>).reset_index(drop=<span class="hljs-literal">True</span>)<br>    df[<span class="hljs-string">&#x27;trade_day&#x27;</span>] = df[<span class="hljs-string">&#x27;trade_day&#x27;</span>].astype(<span class="hljs-built_in">str</span>)<br>    <span class="hljs-keyword">return</span> df<br></code></pre></td></tr></table></figure>

<p>我们以茅台(600519.SH)为例,读取’2020-01-01’至’2022-07-07’间的数据：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kline_df = load_jqdata_kline(<span class="hljs-attribute">code</span>=<span class="hljs-string">&#x27;600519.SH&#x27;</span>, <span class="hljs-attribute">start_date</span>=<span class="hljs-string">&#x27;2020-01-01&#x27;</span>, <span class="hljs-attribute">end_date</span>=<span class="hljs-string">&#x27;2022-07-07&#x27;</span>)<br><span class="hljs-builtin-name">print</span>(kline_df.iloc[-5:])<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">code</th>
<th align="left">dtype</th>
<th align="left">trade_day</th>
<th align="left">trade_time</th>
<th align="right">open</th>
<th align="right">close</th>
<th align="right">low</th>
<th align="right">high</th>
<th align="right">volume</th>
<th align="right">money</th>
<th align="right">avg</th>
<th align="right">pre_close</th>
<th align="right">daily_percent</th>
<th align="right">minutes_of_day</th>
<th align="right">label_d0_25</th>
<th align="right">label_d0_50</th>
<th align="right">label_d0_75</th>
<th align="right">label_rolling_5_50_bps</th>
<th align="right">label_rolling_5_50</th>
<th align="right">label_rolling_10_50_bps</th>
<th align="right">label_rolling_10_50</th>
</tr>
</thead>
<tbody><tr>
<td align="left">600519.XSHG</td>
<td align="left">STOCK</td>
<td align="left">2022-07-07</td>
<td align="left">2022-07-07 14:54:00+08:00</td>
<td align="right">1994.86</td>
<td align="right">1993.66</td>
<td align="right">1993.66</td>
<td align="right">1994.86</td>
<td align="right">10500</td>
<td align="right">2.09366e+07</td>
<td align="right">1993.99</td>
<td align="right">2002</td>
<td align="right">-0.00416583</td>
<td align="right">894</td>
<td align="right">-0.0850054</td>
<td align="right">-0.0308427</td>
<td align="right">-0.0132899</td>
<td align="right">-61.5</td>
<td align="right">-0.0308427</td>
<td align="right">-0.615</td>
<td align="right">-0.000308427</td>
</tr>
<tr>
<td align="left">600519.XSHG</td>
<td align="left">STOCK</td>
<td align="left">2022-07-07</td>
<td align="left">2022-07-07 14:55:00+08:00</td>
<td align="right">1993.58</td>
<td align="right">1994.04</td>
<td align="right">1993.57</td>
<td align="right">1994.5</td>
<td align="right">8900</td>
<td align="right">1.77452e+07</td>
<td align="right">1993.83</td>
<td align="right">2002</td>
<td align="right">-0.00397602</td>
<td align="right">895</td>
<td align="right">-0.115356</td>
<td align="right">-0.0386191</td>
<td align="right">-0.0228204</td>
<td align="right">-77</td>
<td align="right">-0.0386191</td>
<td align="right">-0.77</td>
<td align="right">-0.000386191</td>
</tr>
<tr>
<td align="left">600519.XSHG</td>
<td align="left">STOCK</td>
<td align="left">2022-07-07</td>
<td align="left">2022-07-07 14:56:00+08:00</td>
<td align="right">1993.99</td>
<td align="right">1993.68</td>
<td align="right">1993.51</td>
<td align="right">1993.99</td>
<td align="right">18700</td>
<td align="right">3.72816e+07</td>
<td align="right">1993.69</td>
<td align="right">2002</td>
<td align="right">-0.00415584</td>
<td align="right">896</td>
<td align="right">-0.146713</td>
<td align="right">-0.108342</td>
<td align="right">-0.0699708</td>
<td align="right">-216</td>
<td align="right">-0.108342</td>
<td align="right">-2.16</td>
<td align="right">-0.00108342</td>
</tr>
<tr>
<td align="left">600519.XSHG</td>
<td align="left">STOCK</td>
<td align="left">2022-07-07</td>
<td align="left">2022-07-07 14:57:00+08:00</td>
<td align="right">1993.29</td>
<td align="right">1993</td>
<td align="right">1993</td>
<td align="right">1993.29</td>
<td align="right">15900</td>
<td align="right">3.16902e+07</td>
<td align="right">1993.06</td>
<td align="right">2002</td>
<td align="right">-0.0044955</td>
<td align="right">897</td>
<td align="right">-0.153533</td>
<td align="right">-0.153533</td>
<td align="right">-0.153533</td>
<td align="right">-306</td>
<td align="right">-0.153533</td>
<td align="right">-3.06</td>
<td align="right">-0.00153533</td>
</tr>
<tr>
<td align="left">600519.XSHG</td>
<td align="left">STOCK</td>
<td align="left">2022-07-07</td>
<td align="left">2022-07-07 15:00:00+08:00</td>
<td align="right">1993.01</td>
<td align="right">1990</td>
<td align="right">1990</td>
<td align="right">1993.01</td>
<td align="right">47800</td>
<td align="right">9.51379e+07</td>
<td align="right">1990</td>
<td align="right">2002</td>
<td align="right">-0.00599401</td>
<td align="right">900</td>
<td align="right">nan</td>
<td align="right">nan</td>
<td align="right">nan</td>
<td align="right">nan</td>
<td align="right">nan</td>
<td align="right">nan</td>
<td align="right">nan</td>
</tr>
</tbody></table>
<h2 id="构建日内特征-分钟级"><a href="#构建日内特征-分钟级" class="headerlink" title="构建日内特征(分钟级)"></a>构建日内特征(分钟级)</h2><p>读取K线数据后，便进行最重要的特征提取工作，同时生成对应的标签</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_tech_feature_intraday_jqdata</span>(<span class="hljs-params">kline_df, index_col=<span class="hljs-string">&#x27;trade_time&#x27;</span></span>):</span><br>    df_grouped = kline_df.set_index(index_col).groupby(<span class="hljs-string">&#x27;trade_day&#x27;</span>, as_index=<span class="hljs-literal">False</span>)<br><br>    rsi_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.rsi(length=<span class="hljs-number">5</span>) / <span class="hljs-number">100</span>)).fillna(<span class="hljs-number">0.5</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    cmo_3 =  (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.cmo(length=<span class="hljs-number">3</span>) / <span class="hljs-number">100</span>)).fillna(<span class="hljs-number">0.0</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    natr_3 =  (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.natr(length=<span class="hljs-number">3</span>))).fillna(<span class="hljs-number">0.0</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    rvi_5 =  (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.rvi(length=<span class="hljs-number">5</span>) / <span class="hljs-number">100</span>)).fillna(<span class="hljs-number">0.5</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">try</span>:<br>        kdj_9_3 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.kdj(<span class="hljs-number">9</span>, <span class="hljs-number">3</span>) / <span class="hljs-number">100</span>)).fillna(<span class="hljs-number">0.5</span>).reset_index(drop=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">except</span>:<br>        kdj_9_3 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.kdj(<span class="hljs-built_in">min</span>(<span class="hljs-number">9</span>, <span class="hljs-built_in">len</span>(row)), <span class="hljs-number">3</span>).T.reset_index(drop=<span class="hljs-literal">True</span>).T / <span class="hljs-number">100</span>)).fillna(<span class="hljs-number">0.5</span>).reset_index(drop=<span class="hljs-literal">True</span>)<br>        kdj_9_3.columns = [<span class="hljs-string">&#x27;K_9_3&#x27;</span>, <span class="hljs-string">&#x27;D_9_3&#x27;</span>, <span class="hljs-string">&#x27;J_9_3&#x27;</span>]<br>    adx_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.adx(length=<span class="hljs-number">5</span>) / <span class="hljs-number">100</span>)).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.0</span>).reset_index(drop=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">try</span>:<br>        mfi_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.mfi(length=<span class="hljs-number">5</span>) / <span class="hljs-number">100</span>)).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.5</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">except</span>:<br>        mfi_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.mfi(length=<span class="hljs-built_in">min</span>(<span class="hljs-number">5</span>, <span class="hljs-built_in">len</span>(row))).rename(<span class="hljs-string">&#x27;MFI_5&#x27;</span>) / <span class="hljs-number">100</span>)).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.5</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    pvi_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.pvi(length=<span class="hljs-number">5</span>) / <span class="hljs-number">1000</span>)).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">1</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    nvi_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.nvi(length=<span class="hljs-number">5</span>) / <span class="hljs-number">1000</span>)).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">1</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    willr_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.willr(length=<span class="hljs-number">5</span>) / <span class="hljs-number">100</span>)).clip(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>).fillna(-<span class="hljs-number">0.5</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">try</span>:<br>        willr_10 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.willr(length=<span class="hljs-number">10</span>) / <span class="hljs-number">100</span>)).clip(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>).fillna(-<span class="hljs-number">0.5</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">except</span>:<br>        willr_10 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.willr(length=<span class="hljs-built_in">min</span>(<span class="hljs-number">10</span>, <span class="hljs-built_in">len</span>(row))).rename(<span class="hljs-string">&#x27;WILLR_10&#x27;</span>) / <span class="hljs-number">100</span>)).clip(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>).fillna(-<span class="hljs-number">0.5</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">try</span>:<br>        cmf_10 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.cmf(length=<span class="hljs-number">10</span>) )).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.0</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">except</span>:<br>        cmf_10 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.cmf(length=<span class="hljs-built_in">min</span>(<span class="hljs-number">10</span>, <span class="hljs-built_in">len</span>(row))).rename(<span class="hljs-string">&#x27;CMF_10&#x27;</span>) )).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.0</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    dpo_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.dpo(length=<span class="hljs-number">5</span>, lookahead=<span class="hljs-literal">False</span>) * <span class="hljs-number">10</span> )).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.0</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>)<br>    log_return_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.log_return(length=<span class="hljs-number">5</span>) * <span class="hljs-number">50</span> )).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.0</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>) <br>    zscore_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row.ta.zscore(length=<span class="hljs-number">5</span>) )).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.0</span>).to_frame().reset_index(drop=<span class="hljs-literal">True</span>) <br>    pct_change_3 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row[<span class="hljs-string">&#x27;avg&#x27;</span>].pct_change(periods=<span class="hljs-number">3</span>).fillna(<span class="hljs-number">0</span>) * <span class="hljs-number">50</span> / <span class="hljs-number">3</span>)).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).to_frame().rename(columns=&#123;<span class="hljs-string">&#x27;avg&#x27;</span>: <span class="hljs-string">&#x27;pct_change_3&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>) <br>    pct_change_6 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row[<span class="hljs-string">&#x27;avg&#x27;</span>].pct_change(periods=<span class="hljs-number">6</span>).fillna(<span class="hljs-number">0</span>) * <span class="hljs-number">50</span> / <span class="hljs-number">6</span>)).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).to_frame().rename(columns=&#123;<span class="hljs-string">&#x27;avg&#x27;</span>: <span class="hljs-string">&#x27;pct_change_6&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>) <br>    <br>    rolling_std_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: row[<span class="hljs-string">&#x27;avg&#x27;</span>].rolling(<span class="hljs-number">5</span>, min_periods=<span class="hljs-number">1</span>).std(ddof=<span class="hljs-number">0</span>))).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).to_frame().rename(columns=&#123;<span class="hljs-string">&#x27;avg&#x27;</span>: <span class="hljs-string">&#x27;rolling_std_5&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>)<br>    rolling_money_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: np.log1p(row[<span class="hljs-string">&#x27;money&#x27;</span>].rolling(<span class="hljs-number">5</span>, min_periods=<span class="hljs-number">1</span>).mean()) - np.log1p(row[<span class="hljs-string">&#x27;money&#x27;</span>]) ) / <span class="hljs-number">10.0</span>).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).to_frame().rename(columns=&#123;<span class="hljs-string">&#x27;money&#x27;</span>: <span class="hljs-string">&#x27;rolling_money_5&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>)<br>    rolling_money_6_3 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: np.log1p(row[<span class="hljs-string">&#x27;money&#x27;</span>].rolling(<span class="hljs-number">6</span>, min_periods=<span class="hljs-number">1</span>).mean()) - np.log1p(row[<span class="hljs-string">&#x27;money&#x27;</span>].rolling(<span class="hljs-number">3</span>, min_periods=<span class="hljs-number">1</span>).mean()) ) / <span class="hljs-number">10.0</span> ).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).to_frame().rename(columns=&#123;<span class="hljs-string">&#x27;money&#x27;</span>: <span class="hljs-string">&#x27;rolling_money_6_3&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>)<br>    rolling_volume_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: np.log1p(row[<span class="hljs-string">&#x27;volume&#x27;</span>].rolling(<span class="hljs-number">5</span>, min_periods=<span class="hljs-number">1</span>).mean()) - np.log1p(row[<span class="hljs-string">&#x27;volume&#x27;</span>]) )/ <span class="hljs-number">10.0</span>).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).to_frame().rename(columns=&#123;<span class="hljs-string">&#x27;volume&#x27;</span>: <span class="hljs-string">&#x27;rolling_volume_5&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>)<br>    rolling_volume_6_3 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: np.log1p(row[<span class="hljs-string">&#x27;volume&#x27;</span>].rolling(<span class="hljs-number">6</span>, min_periods=<span class="hljs-number">1</span>).mean()) - np.log1p(row[<span class="hljs-string">&#x27;volume&#x27;</span>].rolling(<span class="hljs-number">3</span>, min_periods=<span class="hljs-number">1</span>).mean()) )/ <span class="hljs-number">10.0</span>).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).to_frame().rename(columns=&#123;<span class="hljs-string">&#x27;volume&#x27;</span>: <span class="hljs-string">&#x27;rolling_volume_6_3&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>)<br>    pct_volatility = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: (row[<span class="hljs-string">&#x27;high&#x27;</span>] - row[<span class="hljs-string">&#x27;low&#x27;</span>]) * <span class="hljs-number">50</span> / row[<span class="hljs-string">&#x27;avg&#x27;</span>])).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.0</span>).to_frame().rename(columns=&#123;<span class="hljs-number">0</span>: <span class="hljs-string">&#x27;pct_volatility&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>) <br>    rolling_pct_volatility_5 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: (row[<span class="hljs-string">&#x27;high&#x27;</span>].rolling(<span class="hljs-number">5</span>, min_periods=<span class="hljs-number">1</span>).<span class="hljs-built_in">max</span>() - row[<span class="hljs-string">&#x27;low&#x27;</span>].rolling(<span class="hljs-number">5</span>, min_periods=<span class="hljs-number">1</span>).<span class="hljs-built_in">min</span>())* <span class="hljs-number">20</span> / row[<span class="hljs-string">&#x27;avg&#x27;</span>])).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.0</span>).to_frame().rename(columns=&#123;<span class="hljs-number">0</span>: <span class="hljs-string">&#x27;rolling_pct_volatility_5&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>) <br>    rolling_pct_volatility_10 = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: (row[<span class="hljs-string">&#x27;high&#x27;</span>].rolling(<span class="hljs-number">10</span>, min_periods=<span class="hljs-number">1</span>).<span class="hljs-built_in">max</span>() - row[<span class="hljs-string">&#x27;low&#x27;</span>].rolling(<span class="hljs-number">10</span>, min_periods=<span class="hljs-number">1</span>).<span class="hljs-built_in">min</span>()) * <span class="hljs-number">20</span> / row[<span class="hljs-string">&#x27;avg&#x27;</span>])).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.0</span>).to_frame().rename(columns=&#123;<span class="hljs-number">0</span>: <span class="hljs-string">&#x27;rolling_pct_volatility_10&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>) <br>    pct_vwap_low = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: (row.ta.vwap() - row[<span class="hljs-string">&#x27;low&#x27;</span>]) * <span class="hljs-number">50</span> / row[<span class="hljs-string">&#x27;avg&#x27;</span>])).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.0</span>).to_frame().rename(columns=&#123;<span class="hljs-number">0</span>: <span class="hljs-string">&#x27;pct_vwap_low&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>) <br>    pct_vwap_high = (df_grouped.apply(<span class="hljs-keyword">lambda</span> row: (row[<span class="hljs-string">&#x27;high&#x27;</span>] - row.ta.vwap()) * <span class="hljs-number">50</span> / row[<span class="hljs-string">&#x27;avg&#x27;</span>])).clip(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>).fillna(<span class="hljs-number">0.0</span>).to_frame().rename(columns=&#123;<span class="hljs-number">0</span>: <span class="hljs-string">&#x27;pct_vwap_high&#x27;</span>&#125;).reset_index(drop=<span class="hljs-literal">True</span>) <br>    <br>    feature = pd.concat([rsi_5, cmo_3, natr_3, rvi_5, kdj_9_3,  adx_5, mfi_5, pvi_5, nvi_5, willr_5, willr_10, cmf_10, dpo_5, log_return_5, zscore_5, pct_change_3, pct_change_6, rolling_std_5, rolling_money_5, rolling_money_6_3, rolling_volume_5, rolling_volume_6_3, pct_volatility, rolling_pct_volatility_5, rolling_pct_volatility_10, pct_vwap_low, pct_vwap_high, kline_df[[<span class="hljs-string">&#x27;daily_percent&#x27;</span>]] * <span class="hljs-number">50</span>], axis=<span class="hljs-number">1</span>) <br>    feature.columns = [<span class="hljs-string">&#x27;intraday_%s&#x27;</span> % i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> feature.columns]<br><br>    index = kline_df[index_col].apply(<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">int</span>(x.timestamp()))<br>    <br>    introday_data = pd.concat([kline_df[[<span class="hljs-string">&#x27;code&#x27;</span>, <span class="hljs-string">&#x27;trade_day&#x27;</span>, <span class="hljs-string">&#x27;minutes_of_day&#x27;</span>]], feature], axis=<span class="hljs-number">1</span>)<br>    introday_data.index = index<br>    <br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;label_d0_25&#x27;</span> <span class="hljs-keyword">in</span> kline_df.columns:<br>        label_data = kline_df[[<span class="hljs-string">&#x27;code&#x27;</span>, <span class="hljs-string">&#x27;trade_day&#x27;</span>, <span class="hljs-string">&#x27;minutes_of_day&#x27;</span>, <span class="hljs-string">&#x27;label_d0_25&#x27;</span>, <span class="hljs-string">&#x27;label_d0_50&#x27;</span>, <span class="hljs-string">&#x27;label_d0_75&#x27;</span>,<br>           <span class="hljs-string">&#x27;label_rolling_5_50&#x27;</span>, <span class="hljs-string">&#x27;label_rolling_10_50&#x27;</span>, <span class="hljs-string">&#x27;label_rolling_5_50_bps&#x27;</span>, <span class="hljs-string">&#x27;label_rolling_10_50_bps&#x27;</span>]]<br>        label_data.index = index<br>    <span class="hljs-keyword">else</span>:<br>        label_data = []<br><br>    introday_data = introday_data[introday_data.minutes_of_day != <span class="hljs-number">900</span>]    <br>    label_data = label_data[label_data.minutes_of_day != <span class="hljs-number">900</span>]        <br>    <span class="hljs-keyword">return</span> introday_data.reset_index(), label_data.reset_index()<br></code></pre></td></tr></table></figure>

<p>同样的，我们展示上面茅台数据生成经过pandas-ta提取的特征：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">introday_data, label_data = make_tech_feature_intraday_jqdata(kline_df, index_col=<span class="hljs-string">&#x27;trade_time&#x27;</span>)<br><span class="hljs-built_in">print</span>(introday_data.iloc[-<span class="hljs-number">5</span>:])<br><span class="hljs-built_in">print</span>(label_data.iloc[-<span class="hljs-number">5</span>:])<br><br></code></pre></td></tr></table></figure>

<ul>
<li>日内数据特征：</li>
</ul>
<table>
<thead>
<tr>
<th align="right">trade_time</th>
<th align="left">code</th>
<th align="left">trade_day</th>
<th align="right">minutes_of_day</th>
<th align="right">intraday_RSI_5</th>
<th align="right">intraday_CMO_3</th>
<th align="right">intraday_NATR_3</th>
<th align="right">intraday_RVI_5</th>
<th align="right">intraday_K_9_3</th>
<th align="right">intraday_D_9_3</th>
<th align="right">intraday_J_9_3</th>
<th align="right">intraday_ADX_5</th>
<th align="right">intraday_DMP_5</th>
<th align="right">intraday_DMN_5</th>
<th align="right">intraday_MFI_5</th>
<th align="right">intraday_PVI_5</th>
<th align="right">intraday_NVI_5</th>
<th align="right">intraday_WILLR_5</th>
<th align="right">intraday_WILLR_10</th>
<th align="right">intraday_CMF_10</th>
<th align="right">intraday_DPO_5</th>
<th align="right">intraday_LOGRET_5</th>
<th align="right">intraday_ZS_5</th>
<th align="right">intraday_pct_change_3</th>
<th align="right">intraday_pct_change_6</th>
<th align="right">intraday_rolling_std_5</th>
<th align="right">intraday_rolling_money_5</th>
<th align="right">intraday_rolling_money_6_3</th>
<th align="right">intraday_rolling_volume_5</th>
<th align="right">intraday_rolling_volume_6_3</th>
<th align="right">intraday_pct_volatility</th>
<th align="right">intraday_rolling_pct_volatility_5</th>
<th align="right">intraday_rolling_pct_volatility_10</th>
<th align="right">intraday_pct_vwap_low</th>
<th align="right">intraday_pct_vwap_high</th>
<th align="right">intraday_daily_percent</th>
</tr>
</thead>
<tbody><tr>
<td align="right">1657176780</td>
<td align="left">600519.XSHG</td>
<td align="left">2022-07-07</td>
<td align="right">893</td>
<td align="right">0.4868</td>
<td align="right">-0.064103</td>
<td align="right">0.077846</td>
<td align="right">0.472697</td>
<td align="right">0.536684</td>
<td align="right">0.41818</td>
<td align="right">0.773693</td>
<td align="right">0.404289</td>
<td align="right">0.170589</td>
<td align="right">0.053766</td>
<td align="right">0.589231</td>
<td align="right">0.999701</td>
<td align="right">1.00016</td>
<td align="right">-0.377273</td>
<td align="right">-0.452</td>
<td align="right">0.197077</td>
<td align="right">4.1</td>
<td align="right">0.0310894</td>
<td align="right">-0.381427</td>
<td align="right">0.00802214</td>
<td align="right">0.00689641</td>
<td align="right">0.613697</td>
<td align="right">-0.010953</td>
<td align="right">-0.0104473</td>
<td align="right">-0.011178</td>
<td align="right">-0.0104575</td>
<td align="right">0.03508</td>
<td align="right">0.0220503</td>
<td align="right">0.0250571</td>
<td align="right">0.0622761</td>
<td align="right">-0.0271961</td>
<td align="right">-0.178072</td>
</tr>
<tr>
<td align="right">1657176840</td>
<td align="left">600519.XSHG</td>
<td align="left">2022-07-07</td>
<td align="right">894</td>
<td align="right">0.377828</td>
<td align="right">-0.418172</td>
<td align="right">0.0721596</td>
<td align="right">0.306806</td>
<td align="right">0.382032</td>
<td align="right">0.406131</td>
<td align="right">0.333835</td>
<td align="right">0.33549</td>
<td align="right">0.144056</td>
<td align="right">0.127672</td>
<td align="right">0.353767</td>
<td align="right">0.999656</td>
<td align="right">1.00016</td>
<td align="right">-0.971429</td>
<td align="right">-0.931624</td>
<td align="right">-0.0242737</td>
<td align="right">-10</td>
<td align="right">-0.0225665</td>
<td align="right">-1.63965</td>
<td align="right">-0.00860476</td>
<td align="right">-0.00167135</td>
<td align="right">0.50677</td>
<td align="right">-0.0136592</td>
<td align="right">-0.006727</td>
<td align="right">-0.0136515</td>
<td align="right">-0.00678157</td>
<td align="right">0.0300904</td>
<td align="right">0.0210633</td>
<td align="right">0.0234705</td>
<td align="right">0.0780107</td>
<td align="right">-0.0479203</td>
<td align="right">-0.208292</td>
</tr>
<tr>
<td align="right">1657176900</td>
<td align="left">600519.XSHG</td>
<td align="left">2022-07-07</td>
<td align="right">895</td>
<td align="right">0.428086</td>
<td align="right">-0.203659</td>
<td align="right">0.0636436</td>
<td align="right">0.536757</td>
<td align="right">0.336506</td>
<td align="right">0.382923</td>
<td align="right">0.243674</td>
<td align="right">0.269736</td>
<td align="right">0.125327</td>
<td align="right">0.123655</td>
<td align="right">0.199639</td>
<td align="right">0.999656</td>
<td align="right">1.00009</td>
<td align="right">-0.779343</td>
<td align="right">-0.754545</td>
<td align="right">0.0696795</td>
<td align="right">-7.7</td>
<td align="right">-0.0391013</td>
<td align="right">-0.75092</td>
<td align="right">-0.0102754</td>
<td align="right">0.000668783</td>
<td align="right">0.638041</td>
<td align="right">0.00777374</td>
<td align="right">-0.00850169</td>
<td align="right">0.00777846</td>
<td align="right">-0.00857828</td>
<td align="right">0.0233219</td>
<td align="right">0.0213659</td>
<td align="right">0.0220681</td>
<td align="right">0.0799701</td>
<td align="right">-0.0566481</td>
<td align="right">-0.198801</td>
</tr>
<tr>
<td align="right">1657176960</td>
<td align="left">600519.XSHG</td>
<td align="left">2022-07-07</td>
<td align="right">896</td>
<td align="right">0.390711</td>
<td align="right">-0.344547</td>
<td align="right">0.051298</td>
<td align="right">0.344622</td>
<td align="right">0.25161</td>
<td align="right">0.339152</td>
<td align="right">0.0765271</td>
<td align="right">0.222581</td>
<td align="right">0.114705</td>
<td align="right">0.122769</td>
<td align="right">0.165302</td>
<td align="right">0.999611</td>
<td align="right">1.00009</td>
<td align="right">-0.922374</td>
<td align="right">-0.918182</td>
<td align="right">0.0739293</td>
<td align="right">-10</td>
<td align="right">-0.0223156</td>
<td align="right">-0.902093</td>
<td align="right">-0.0146167</td>
<td align="right">-0.00330078</td>
<td align="right">0.709123</td>
<td align="right">-0.0476034</td>
<td align="right">-0.0131696</td>
<td align="right">-0.0475763</td>
<td align="right">-0.0131647</td>
<td align="right">0.012038</td>
<td align="right">0.0219693</td>
<td align="right">0.0220696</td>
<td align="right">0.0807789</td>
<td align="right">-0.0687409</td>
<td align="right">-0.207792</td>
</tr>
<tr>
<td align="right">1657177020</td>
<td align="left">600519.XSHG</td>
<td align="left">2022-07-07</td>
<td align="right">897</td>
<td align="right">0.323935</td>
<td align="right">-0.563402</td>
<td align="right">0.0455835</td>
<td align="right">0.243084</td>
<td align="right">0.16774</td>
<td align="right">0.282015</td>
<td align="right">-0.0608087</td>
<td align="right">0.242891</td>
<td align="right">0.100978</td>
<td align="right">0.197831</td>
<td align="right">2.9012e-16</td>
<td align="right">0.999611</td>
<td align="right">0.999951</td>
<td align="right">-1</td>
<td align="right">-1</td>
<td align="right">-0.143719</td>
<td align="right">-10</td>
<td align="right">-0.0674407</td>
<td align="right">-1.39213</td>
<td align="right">-0.00777336</td>
<td align="right">-0.00818705</td>
<td align="right">0.785147</td>
<td align="right">-0.0210747</td>
<td align="right">-0.0162005</td>
<td align="right">-0.0210629</td>
<td align="right">-0.0161831</td>
<td align="right">0.00727525</td>
<td align="right">0.027094</td>
<td align="right">0.027094</td>
<td align="right">0.0928892</td>
<td align="right">-0.0856139</td>
<td align="right">-0.224775</td>
</tr>
</tbody></table>
<ul>
<li>日内标签数据</li>
</ul>
<table>
<thead>
<tr>
<th align="right">trade_time</th>
<th align="left">code</th>
<th align="left">trade_day</th>
<th align="right">minutes_of_day</th>
<th align="right">label_d0_25</th>
<th align="right">label_d0_50</th>
<th align="right">label_d0_75</th>
<th align="right">label_rolling_5_50</th>
<th align="right">label_rolling_10_50</th>
<th align="right">label_rolling_5_50_bps</th>
<th align="right">label_rolling_10_50_bps</th>
</tr>
</thead>
<tbody><tr>
<td align="right">1657176780</td>
<td align="left">600519.XSHG</td>
<td align="left">2022-07-07</td>
<td align="right">893</td>
<td align="right">-0.119272</td>
<td align="right">-0.0877</td>
<td align="right">-0.080684</td>
<td align="right">-0.0877</td>
<td align="right">-0.000877</td>
<td align="right">-175</td>
<td align="right">-1.75</td>
</tr>
<tr>
<td align="right">1657176840</td>
<td align="left">600519.XSHG</td>
<td align="left">2022-07-07</td>
<td align="right">894</td>
<td align="right">-0.0850054</td>
<td align="right">-0.0308427</td>
<td align="right">-0.0132899</td>
<td align="right">-0.0308427</td>
<td align="right">-0.000308427</td>
<td align="right">-61.5</td>
<td align="right">-0.615</td>
</tr>
<tr>
<td align="right">1657176900</td>
<td align="left">600519.XSHG</td>
<td align="left">2022-07-07</td>
<td align="right">895</td>
<td align="right">-0.115356</td>
<td align="right">-0.0386191</td>
<td align="right">-0.0228204</td>
<td align="right">-0.0386191</td>
<td align="right">-0.000386191</td>
<td align="right">-77</td>
<td align="right">-0.77</td>
</tr>
<tr>
<td align="right">1657176960</td>
<td align="left">600519.XSHG</td>
<td align="left">2022-07-07</td>
<td align="right">896</td>
<td align="right">-0.146713</td>
<td align="right">-0.108342</td>
<td align="right">-0.0699708</td>
<td align="right">-0.108342</td>
<td align="right">-0.00108342</td>
<td align="right">-216</td>
<td align="right">-2.16</td>
</tr>
<tr>
<td align="right">1657177020</td>
<td align="left">600519.XSHG</td>
<td align="left">2022-07-07</td>
<td align="right">897</td>
<td align="right">-0.153533</td>
<td align="right">-0.153533</td>
<td align="right">-0.153533</td>
<td align="right">-0.153533</td>
<td align="right">-0.00153533</td>
<td align="right">-306</td>
<td align="right">-3.06</td>
</tr>
</tbody></table>
<p>简单计算技术因子与日内收益的相关性：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">corr_data = []<br><span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> introday_data.columns.tolist()[<span class="hljs-number">4</span>:]:<br>    feature = introday_data[col]<br>    label_d0_50 = feature.corr(label_data[<span class="hljs-string">&#x27;label_d0_50&#x27;</span>])<br>    label_rolling_5_50 = feature.corr(label_data[<span class="hljs-string">&#x27;label_rolling_5_50&#x27;</span>])<br>    label_rolling_10_50 = feature.corr(label_data[<span class="hljs-string">&#x27;label_rolling_10_50&#x27;</span>])<br>    corr_data.append([col, label_d0_50, label_rolling_5_50, label_rolling_10_50])<br>corr_data = pd.DataFrame(corr_data, columns=[<span class="hljs-string">&#x27;feature&#x27;</span>, <span class="hljs-string">&#x27;d0_50&#x27;</span>, <span class="hljs-string">&#x27;rolling_5_50&#x27;</span>, <span class="hljs-string">&#x27;rolling_10_50&#x27;</span>])<br><span class="hljs-built_in">print</span>(corr_data)<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">feature</th>
<th align="right">d0_50</th>
<th align="right">rolling_5_50</th>
<th align="right">rolling_10_50</th>
</tr>
</thead>
<tbody><tr>
<td align="left">intraday_RSI_5</td>
<td align="right">0.0402828</td>
<td align="right">0.134321</td>
<td align="right">0.103664</td>
</tr>
<tr>
<td align="left">intraday_CMO_3</td>
<td align="right">0.0460717</td>
<td align="right">0.163593</td>
<td align="right">0.124605</td>
</tr>
<tr>
<td align="left">intraday_NATR_3</td>
<td align="right">-0.0044438</td>
<td align="right">0.0184311</td>
<td align="right">0.0159059</td>
</tr>
<tr>
<td align="left">intraday_RVI_5</td>
<td align="right">0.0384155</td>
<td align="right">0.139606</td>
<td align="right">0.106858</td>
</tr>
<tr>
<td align="left">intraday_K_9_3</td>
<td align="right">0.0281801</td>
<td align="right">0.0653667</td>
<td align="right">0.0561566</td>
</tr>
<tr>
<td align="left">intraday_D_9_3</td>
<td align="right">0.019375</td>
<td align="right">0.0322949</td>
<td align="right">0.0315525</td>
</tr>
<tr>
<td align="left">intraday_J_9_3</td>
<td align="right">0.0305751</td>
<td align="right">0.0899986</td>
<td align="right">0.0733925</td>
</tr>
<tr>
<td align="left">intraday_ADX_5</td>
<td align="right">0.00178353</td>
<td align="right">0.00119938</td>
<td align="right">-0.00362684</td>
</tr>
<tr>
<td align="left">intraday_DMP_5</td>
<td align="right">0.023113</td>
<td align="right">0.0693602</td>
<td align="right">0.0517322</td>
</tr>
<tr>
<td align="left">intraday_DMN_5</td>
<td align="right">-0.0211941</td>
<td align="right">-0.0660362</td>
<td align="right">-0.0478488</td>
</tr>
<tr>
<td align="left">intraday_MFI_5</td>
<td align="right">0.0187832</td>
<td align="right">0.0573829</td>
<td align="right">0.0454739</td>
</tr>
<tr>
<td align="left">intraday_PVI_5</td>
<td align="right">-0.00631178</td>
<td align="right">0.00495645</td>
<td align="right">0.0021088</td>
</tr>
<tr>
<td align="left">intraday_NVI_5</td>
<td align="right">-0.0138721</td>
<td align="right">0.0016334</td>
<td align="right">-0.00108481</td>
</tr>
<tr>
<td align="left">intraday_WILLR_5</td>
<td align="right">0.0508993</td>
<td align="right">0.174907</td>
<td align="right">0.135297</td>
</tr>
<tr>
<td align="left">intraday_WILLR_10</td>
<td align="right">0.0437711</td>
<td align="right">0.133309</td>
<td align="right">0.106649</td>
</tr>
<tr>
<td align="left">intraday_CMF_10</td>
<td align="right">0.0310067</td>
<td align="right">0.0720305</td>
<td align="right">0.060817</td>
</tr>
<tr>
<td align="left">intraday_DPO_5</td>
<td align="right">0.0322019</td>
<td align="right">0.101203</td>
<td align="right">0.0789424</td>
</tr>
<tr>
<td align="left">intraday_LOGRET_5</td>
<td align="right">0.0282654</td>
<td align="right">0.101385</td>
<td align="right">0.0758353</td>
</tr>
<tr>
<td align="left">intraday_ZS_5</td>
<td align="right">0.048193</td>
<td align="right">0.189238</td>
<td align="right">0.140897</td>
</tr>
<tr>
<td align="left">intraday_pct_change_3</td>
<td align="right">0.0111402</td>
<td align="right">0.0316397</td>
<td align="right">0.0211543</td>
</tr>
<tr>
<td align="left">intraday_pct_change_6</td>
<td align="right">0.00922718</td>
<td align="right">0.0199352</td>
<td align="right">0.0154407</td>
</tr>
<tr>
<td align="left">intraday_rolling_std_5</td>
<td align="right">-0.00929529</td>
<td align="right">0.0246064</td>
<td align="right">0.0264212</td>
</tr>
<tr>
<td align="left">intraday_rolling_money_5</td>
<td align="right">-0.00175834</td>
<td align="right">-0.0044877</td>
<td align="right">-0.00455773</td>
</tr>
<tr>
<td align="left">intraday_rolling_money_6_3</td>
<td align="right">-0.00369373</td>
<td align="right">-0.00865403</td>
<td align="right">-0.009164</td>
</tr>
<tr>
<td align="left">intraday_rolling_volume_5</td>
<td align="right">-0.00169721</td>
<td align="right">-0.00431745</td>
<td align="right">-0.00442322</td>
</tr>
<tr>
<td align="left">intraday_rolling_volume_6_3</td>
<td align="right">-0.00365949</td>
<td align="right">-0.00860967</td>
<td align="right">-0.00912756</td>
</tr>
<tr>
<td align="left">intraday_pct_volatility</td>
<td align="right">0.00960336</td>
<td align="right">0.0396089</td>
<td align="right">0.0383</td>
</tr>
<tr>
<td align="left">intraday_rolling_pct_volatility_5</td>
<td align="right">0.0118225</td>
<td align="right">0.0395367</td>
<td align="right">0.0425203</td>
</tr>
<tr>
<td align="left">intraday_rolling_pct_volatility_10</td>
<td align="right">0.00827556</td>
<td align="right">0.0335309</td>
<td align="right">0.0334182</td>
</tr>
<tr>
<td align="left">intraday_pct_vwap_low</td>
<td align="right">0.0097716</td>
<td align="right">-0.00987224</td>
<td align="right">-0.00514639</td>
</tr>
<tr>
<td align="left">intraday_pct_vwap_high</td>
<td align="right">-0.00828736</td>
<td align="right">0.015894</td>
<td align="right">0.0109779</td>
</tr>
<tr>
<td align="left">intraday_daily_percent</td>
<td align="right">0.0473394</td>
<td align="right">0.025758</td>
<td align="right">0.0216949</td>
</tr>
</tbody></table>
<p>可以发现，5min/10min的相关性还是有一些的，说明技术指标短期内可以起到一些预测作用，这也给我们做<strong>日内高频可转债</strong>提供了一个思路。</p>
<h2 id="特征转存数据库"><a href="#特征转存数据库" class="headerlink" title="特征转存数据库"></a>特征转存数据库</h2><p>这里以日内特征为例，构建数据表，应用上述特征抽取函数，提取技术面特征，然后存储到Clickhouse数据库中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> clickhouse_driver <span class="hljs-keyword">import</span> Client<br><br>storage_client = Client(<span class="hljs-string">&#x27;10.0.16.11&#x27;</span>, password=<span class="hljs-string">&#x27;******&#x27;</span>, settings=&#123;<span class="hljs-string">&#x27;use_numpy&#x27;</span>: <span class="hljs-literal">True</span>&#125;)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_cn_intraday_set</span>(<span class="hljs-params">start_date=<span class="hljs-string">&#x27;2018-01-01&#x27;</span>, end_date=<span class="hljs-string">&#x27;2022-07-01&#x27;</span></span>):</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    主要股票：日内特征</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    create_table_intraday_cn_data = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        create table if not exists feature.intraday_cn_data</span><br><span class="hljs-string">        (</span><br><span class="hljs-string">            trade_time DateTime(&#x27;Asia/Shanghai&#x27;), code String, trade_day Date, minutes_of_day Int16,</span><br><span class="hljs-string">            intraday_RSI_5 Float32, intraday_CMO_3 Float32, intraday_NATR_3 Float32, intraday_RVI_5 Float32, intraday_K_9_3 Float32, intraday_D_9_3 Float32, intraday_J_9_3 Float32, intraday_ADX_5 Float32, intraday_DMP_5 Float32, intraday_DMN_5 Float32, intraday_MFI_5 Float32, intraday_PVI_5 Float32, intraday_NVI_5 Float32, intraday_WILLR_5 Float32, intraday_WILLR_10 Float32, intraday_CMF_10 Float32, intraday_DPO_5 Float32, intraday_LOGRET_5 Float32, intraday_ZS_5 Float32, intraday_pct_change_3 Float32, intraday_pct_change_6 Float32, intraday_rolling_std_5 Float32, intraday_rolling_money_5 Float32, intraday_rolling_money_6_3 Float32, intraday_rolling_volume_5 Float32, intraday_rolling_volume_6_3 Float32, intraday_pct_volatility Float32, intraday_rolling_pct_volatility_5 Float32, intraday_rolling_pct_volatility_10 Float32, intraday_pct_vwap_low Float32, intraday_pct_vwap_high Float32, intraday_daily_percent Float32</span><br><span class="hljs-string">        )</span><br><span class="hljs-string">        ENGINE = ReplacingMergeTree()</span><br><span class="hljs-string">        ORDER BY (trade_day, trade_time, code)</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    storage_client.execute(create_table_intraday_cn_data)<br><br>    create_table_intraday_cn_label = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        create table if not exists feature.intraday_cn_label</span><br><span class="hljs-string">        (</span><br><span class="hljs-string">            trade_time DateTime(&#x27;Asia/Shanghai&#x27;), code String, trade_day Date, minutes_of_day Int16,</span><br><span class="hljs-string">            label_d0_25 Float32, label_d0_50 Float32, label_d0_75 Float32,  label_rolling_5_50 Float32,  label_rolling_10_50 Float32,  label_rolling_5_50_bps Float32,  label_rolling_10_50_bps Float32</span><br><span class="hljs-string">        )</span><br><span class="hljs-string">        ENGINE = ReplacingMergeTree()</span><br><span class="hljs-string">        ORDER BY (trade_day, trade_time, code)</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    storage_client.execute(create_table_intraday_cn_label)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make</span>(<span class="hljs-params">code</span>):</span><br>        <span class="hljs-comment"># 读取K线</span><br>        kline_df = load_jqdata_kline(code=code, start_date=start_date, end_date=end_date)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(kline_df) &lt; <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span><br>        <span class="hljs-comment"># 生成特征和标签</span><br>        introday_data, label_data = make_tech_feature_intraday_jqdata(kline_df)<br>        <span class="hljs-comment"># 分批写入，降低性能压力</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(introday_data) &gt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">int</span>(np.ceil(<span class="hljs-built_in">len</span>(introday_data) / <span class="hljs-number">2000</span>))):<br>                storage_client.insert_dataframe(<span class="hljs-string">&#x27;INSERT INTO feature.intraday_cn_data  VALUES&#x27;</span>, introday_data.iloc[i * <span class="hljs-number">2000</span>: (i+<span class="hljs-number">1</span>)*<span class="hljs-number">2000</span>])<br>                storage_client.insert_dataframe(<span class="hljs-string">&#x27;INSERT INTO feature.intraday_cn_label VALUES&#x27;</span>, label_data.iloc[i * <span class="hljs-number">2000</span>: (i+<span class="hljs-number">1</span>)*<span class="hljs-number">2000</span>])<br>    <br>    <span class="hljs-comment"># 获取指定的股票列表</span><br>    tickers = get_jq_ticker(start_date, end_date)<br><br>    <span class="hljs-comment"># 遍历股票，生成特征</span><br>    <span class="hljs-keyword">for</span> ticker <span class="hljs-keyword">in</span> tqdm(tickers): <br>            make(ticker)<br></code></pre></td></tr></table></figure>

<p>至此，我们完成了技术特征数据的提取、存储工作。</p>
<hr>
<p>欢迎关注我的公众号“<strong>量化实战</strong>”，原创技术文章第一时间推送。</p>
<p><img src="/img/qrcode.jpg" srcset="/img/loading.gif" lazyload></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E9%87%8F%E5%8C%96/">量化</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/talib/">talib</a>
                    
                      <a class="hover-with-bg" href="/tags/pandas-ta/">pandas_ta</a>
                    
                      <a class="hover-with-bg" href="/tags/%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/">技术分析</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/10/%E8%BF%85%E6%8A%95QMT%E8%82%A1%E7%A5%A8%E4%BA%A4%E6%98%93%E6%8E%A5%E5%8F%A3%E5%B0%81%E8%A3%85/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">迅投QMT量化平台交易接口封装</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/08/AI%E9%A2%84%E6%B5%8B%E8%82%A1%E7%A5%A8%E4%B9%8B%E6%96%B0%E9%97%BB%E4%BA%8B%E4%BB%B6%E6%95%B0%E6%8D%AE/">
                        <span class="hidden-mobile">基于新闻事件Bert序列建模的行业涨跌预测</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"NQndU9io17iF8X4gY3Ifs1RO-gzGzoHsz","appKey":"ODqlMdJWwrMxHFHzfz3pMvBS","path":"window.location.pathname","placeholder":"说点什么","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":null,"emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appid":"NQndU9io17iF8X4gY3Ifs1RO-gzGzoHsz","appkey":"ODqlMdJWwrMxHFHzfz3pMvBS"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          Fluid.plugins.initFancyBox('#valine .vcontent img:not(.vemoji)');
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        粤ICP备19097965号
      </a>
    </span>
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.2/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>
  




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?e2bacb4062644434b87a03658392592e";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  
    <!-- Google gtag.js -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7YSYVRNN9T"></script>
    <script defer>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7YSYVRNN9T');
    </script>
  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
